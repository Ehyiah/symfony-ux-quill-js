{"version":3,"file":"imageUploader.js","names":["LoadingImage","ImageUploader","constructor","quill","options","range","placeholderDelta","upload","console","warn","toolbar","getModule","addHandler","selectLocalImage","bind","handleDrop","handlePaste","root","addEventListener","focus","getSelection","fileHolder","document","createElement","setAttribute","onchange","fileChanged","body","appendChild","click","window","requestAnimationFrame","removeChild","evt","dataTransfer","files","length","stopPropagation","preventDefault","caretRangeFromPoint","selection","clientX","clientY","setBaseAndExtent","startContainer","startOffset","caretPositionFromPoint","offsetNode","offset","file","setTimeout","readAndUploadFile","clipboard","clipboardData","items","IMAGE_MIME_REGEX","i","test","type","getAsFile","isUploadReject","fileReader","FileReader","base64ImageSrc","result","insertBase64Image","readAsDataURL","then","imageUrl","insertToEditor","error","removeBase64Image","url","insertEmbed","index","blotName","lengthToDelete","calculatePlaceholderInsertLength","deleteText","setSelection","ops","reduce","accumulator","deltaOperation","hasBarProperty","Object","prototype","hasOwnProperty","call"],"sources":["../src/imageUploader.ts"],"sourcesContent":["import LoadingImage from './blots/image.js';\n\nclass ImageUploader {\n    constructor(quill, options) {\n        this.quill = quill;\n        this.options = options;\n        this.range = null;\n        this.placeholderDelta = null;\n\n        if (typeof this.options.upload !== 'function')\n            console.warn(\n                '[Missing config] upload function that returns a promise is required'\n            );\n\n        const toolbar = this.quill.getModule('toolbar');\n        if (toolbar) {\n            toolbar.addHandler('image', this.selectLocalImage.bind(this));\n        }\n\n        this.handleDrop = this.handleDrop.bind(this);\n        this.handlePaste = this.handlePaste.bind(this);\n\n        this.quill.root.addEventListener('drop', this.handleDrop, false);\n        this.quill.root.addEventListener('paste', this.handlePaste, false);\n    }\n\n    selectLocalImage() {\n        this.quill.focus();\n        this.range = this.quill.getSelection();\n        this.fileHolder = document.createElement('input');\n        this.fileHolder.setAttribute('type', 'file');\n        this.fileHolder.setAttribute('accept', 'image/*');\n        this.fileHolder.setAttribute('style', 'visibility:hidden');\n\n        this.fileHolder.onchange = this.fileChanged.bind(this);\n\n        document.body.appendChild(this.fileHolder);\n\n        this.fileHolder.click();\n\n        window.requestAnimationFrame(() => {\n            document.body.removeChild(this.fileHolder);\n        });\n    }\n\n    handleDrop(evt) {\n        if (\n            evt.dataTransfer &&\n            evt.dataTransfer.files &&\n            evt.dataTransfer.files.length\n        ) {\n            evt.stopPropagation();\n            evt.preventDefault();\n            if (document.caretRangeFromPoint) {\n                const selection = document.getSelection();\n                const range = document.caretRangeFromPoint(evt.clientX, evt.clientY);\n                if (selection && range) {\n                    selection.setBaseAndExtent(\n                        range.startContainer,\n                        range.startOffset,\n                        range.startContainer,\n                        range.startOffset\n                    );\n                }\n            } else {\n                const selection = document.getSelection();\n                const range = document.caretPositionFromPoint(evt.clientX, evt.clientY);\n                if (selection && range) {\n                    selection.setBaseAndExtent(\n                        range.offsetNode,\n                        range.offset,\n                        range.offsetNode,\n                        range.offset\n                    );\n                }\n            }\n\n            this.quill.focus();\n            this.range = this.quill.getSelection();\n            const file = evt.dataTransfer.files[0];\n\n            setTimeout(() => {\n                this.quill.focus();\n                this.range = this.quill.getSelection();\n                this.readAndUploadFile(file);\n            }, 0);\n        }\n    }\n\n    handlePaste(evt) {\n        const clipboard = evt.clipboardData || window.clipboardData;\n\n        // IE 11 is .files other browsers are .items\n        if (clipboard && (clipboard.items || clipboard.files)) {\n            const items = clipboard.items || clipboard.files;\n            const IMAGE_MIME_REGEX = /^image\\/(jpe?g|gif|png|svg|webp)$/i;\n\n            for (let i = 0; i < items.length; i++) {\n                if (IMAGE_MIME_REGEX.test(items[i].type)) {\n                    const file = items[i].getAsFile ? items[i].getAsFile() : items[i];\n\n                    if (file) {\n                        this.quill.focus();\n                        this.range = this.quill.getSelection();\n                        evt.preventDefault();\n                        setTimeout(() => {\n                            this.quill.focus();\n                            this.range = this.quill.getSelection();\n                            this.readAndUploadFile(file);\n                        }, 0);\n                    }\n                }\n            }\n        }\n    }\n\n    readAndUploadFile(file) {\n        let isUploadReject = false;\n\n        const fileReader = new FileReader();\n\n        fileReader.addEventListener(\n            'load',\n            () => {\n                if (!isUploadReject) {\n                    const base64ImageSrc = fileReader.result;\n                    this.insertBase64Image(base64ImageSrc);\n                }\n            },\n            false\n        );\n\n        if (file) {\n            fileReader.readAsDataURL(file);\n        }\n\n        this.options.upload(file).then(\n            (imageUrl) => {\n                this.insertToEditor(imageUrl);\n            },\n            (error) => {\n                isUploadReject = true;\n                this.removeBase64Image();\n                console.warn(error);\n            }\n        );\n    }\n\n    fileChanged() {\n        const file = this.fileHolder.files[0];\n        this.readAndUploadFile(file);\n    }\n\n    insertBase64Image(url) {\n        const range = this.range;\n\n        this.placeholderDelta = this.quill.insertEmbed(\n            range.index,\n            LoadingImage.blotName,\n            `${url}`,\n            'user'\n        );\n    }\n\n    insertToEditor(url) {\n        const range = this.range;\n\n        const lengthToDelete = this.calculatePlaceholderInsertLength();\n\n        // Delete the placeholder image\n        this.quill.deleteText(range.index, lengthToDelete, 'user');\n        // Insert the server saved image\n        this.quill.insertEmbed(range.index, 'image', `${url}`, 'user');\n\n        range.index++;\n        this.quill.setSelection(range, 'user');\n    }\n\n    // The length of the insert delta from insertBase64Image can vary depending on what part of the line the insert occurs\n    calculatePlaceholderInsertLength() {\n        return this.placeholderDelta.ops.reduce((accumulator, deltaOperation) => {\n            const hasBarProperty = Object.prototype.hasOwnProperty.call(deltaOperation, 'insert');\n            if (hasBarProperty)\n                accumulator++;\n\n            return accumulator;\n        }, 0);\n    }\n\n    removeBase64Image() {\n        const range = this.range;\n        const lengthToDelete = this.calculatePlaceholderInsertLength();\n\n        this.quill.deleteText(range.index, lengthToDelete, 'user');\n    }\n}\n\nwindow.ImageUploader = ImageUploader;\nexport default ImageUploader;\n"],"mappings":"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"}